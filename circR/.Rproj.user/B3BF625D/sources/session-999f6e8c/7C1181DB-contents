activity_times <- function(df) {
  unique_cages <- unique(df$Cage)
  results <- list()

  for (cage in unique_cages) {
    cage_data <- df %>%
      filter(Cage == cage)

    unique_dates <- unique(cage_data$Date)

    for (date in unique_dates) {
      daily_data <- cage_data %>%
        filter(Date == date)

      if (nrow(daily_data) > 0) {
        daily_mean <- mean(daily_data$HopsPerMinute, na.rm = TRUE)
        cog_time <- as.POSIXct(daily_data$timestamp[floor(nrow(daily_data) / 2)], origin="1970-01-01") # Example CoG time

        onset_result <- find_onset(daily_data, cog_time, daily_mean, interval_minutes = 10, sustained_minutes = 30)
        onset_time <- onset_result$onset_time
        daily_data$rolling_mean_10 <- onset_result$rolling_mean_10

        daily_data <- daily_data %>%
          mutate(onset_time = onset_time)

        daily_data <- find_offset(daily_data)
        results[[paste(cage, date, sep = "_")]] <- daily_data
      }
    }
  }

  combined_data <- bind_rows(results)
  return(combined_data)
}
